{% extends "base.html" %}

{% block title %}AI Study Planner | Chat{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
    .chat-container {
        height: calc(100vh - 70px);
        display: flex;
        flex-direction: column;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        position: relative;
    }

    .chat-container::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="0.5" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.3;
    }

    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        position: relative;
        z-index: 1;
    }

    .message {
        margin-bottom: 15px;
        padding: 15px 20px;
        border-radius: 16px;
        max-width: 85%;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        animation: fadeInUp 0.3s ease-out;
    }

    .user-message {
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        color: white;
        align-self: flex-end;
        border-bottom-right-radius: 5px;
    }

    .agent-message {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        color: var(--text-primary);
        align-self: flex-start;
        border-bottom-left-radius: 5px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .input-group {
        padding: 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-top: 1px solid rgba(255, 255, 255, 0.2);
        position: relative;
        z-index: 1;
    }

    .input-group .form-control {
        border-radius: 25px;
        border: 2px solid var(--border-color);
        padding: 12px 20px;
        font-size: 1rem;
        background: rgba(255, 255, 255, 0.9);
        transition: all 0.3s ease;
    }

    .input-group .form-control:focus {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 0.2rem rgba(99, 102, 241, 0.25);
        background: white;
    }

    .input-group .btn {
        border-radius: 25px;
        padding: 12px 25px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
        border: none;
        transition: all 0.3s ease;
    }

    .input-group .btn:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-lg);
    }

    /* Markdown styling for agent messages */
    .agent-message h1, .agent-message h2, .agent-message h3 {
        color: var(--primary-color);
        margin: 10px 0 5px 0;
        font-weight: 600;
    }

    .agent-message h1 {
        font-size: 1.5rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 5px;
    }

    .agent-message h2 {
        font-size: 1.3rem;
    }

    .agent-message h3 {
        font-size: 1.1rem;
    }

    .agent-message ul, .agent-message ol {
        margin: 10px 0;
        padding-left: 20px;
    }

    .agent-message li {
        margin: 8px 0;
        line-height: 1.5;
    }

    .agent-message strong {
        font-weight: 600;
        color: var(--text-primary);
    }

    .agent-message em {
        font-style: italic;
        color: var(--text-secondary);
    }

    .agent-message code {
        background: rgba(99, 102, 241, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
    }

    .agent-message pre {
        background: rgba(99, 102, 241, 0.1);
        padding: 15px;
        border-radius: 8px;
        overflow-x: auto;
        margin: 10px 0;
    }

    .agent-message blockquote {
        border-left: 4px solid var(--primary-color);
        margin: 10px 0;
        padding-left: 15px;
        color: var(--text-secondary);
        font-style: italic;
    }

    .agent-message hr {
        border: none;
        height: 2px;
        background: linear-gradient(90deg, var(--primary-color), transparent);
        margin: 15px 0;
    }

    /* Course and assignment styling */
    .course-item, .assignment-item, .exam-item {
        background: rgba(248, 250, 252, 0.8);
        padding: 12px;
        border-radius: 8px;
        margin: 8px 0;
        border-left: 4px solid var(--primary-color);
    }

    .priority-urgent { border-left-color: var(--danger-color) !important; }
    .priority-high { border-left-color: var(--warning-color) !important; }
    .priority-medium { border-left-color: var(--accent-color) !important; }
    .priority-low { border-left-color: var(--success-color) !important; }

    .status-completed {
        background: rgba(16, 185, 129, 0.1);
        border-left-color: var(--success-color) !important;
    }

    .status-overdue {
        background: rgba(239, 68, 68, 0.1);
        border-left-color: var(--danger-color) !important;
    }

    /* Loading animation */
    .typing-indicator {
        display: flex;
        align-items: center;
        gap: 5px;
        padding: 15px 20px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 16px;
        border-bottom-left-radius: 5px;
        max-width: 85%;
        align-self: flex-start;
        margin-bottom: 15px;
        animation: fadeInUp 0.3s ease-out;
    }

    .typing-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--primary-color);
        animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }

    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Scrollbar styling */
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb {
        background: var(--primary-color);
        border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
        background: var(--primary-dark);
    }
</style>
{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-messages" id="chat-messages">
        <div class="message agent-message">Hello! I'm your AI Study Planner. What would you like to plan today?</div>
    </div>
    <div class="input-group">
        <input type="text" id="user-input" class="form-control" placeholder="Ask me about your assignments or courses...">
        <button id="send-btn" class="btn btn-primary">Send</button>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Configure marked for better markdown parsing
    marked.setOptions({
        breaks: true,
        gfm: true,
        sanitize: false,
        smartLists: true,
        smartypants: true
    });

    document.getElementById('send-btn').addEventListener('click', sendMessage);
    document.getElementById('user-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });

    function sendMessage() {
        const userInput = document.getElementById('user-input');
        const message = userInput.value.trim();
        if (!message) return;

        const chatMessages = document.getElementById('chat-messages');

        // Display user message
        const userMessageDiv = document.createElement('div');
        userMessageDiv.className = 'message user-message';
        userMessageDiv.textContent = message;
        chatMessages.appendChild(userMessageDiv);
        userInput.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Show typing indicator
        const typingIndicator = createTypingIndicator();
        chatMessages.appendChild(typingIndicator);
        chatMessages.scrollTop = chatMessages.scrollHeight;

        // Send message to Django backend
        fetch("{% url 'chat_api' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ message: message })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Remove typing indicator
            typingIndicator.remove();
            
            // Display AI's response with proper formatting
            const agentMessageDiv = document.createElement('div');
            agentMessageDiv.className = 'message agent-message';
            
            // Process and format the response
            const formattedResponse = formatAIResponse(data.response);
            agentMessageDiv.innerHTML = formattedResponse;
            
            chatMessages.appendChild(agentMessageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        })
        .catch(error => {
            console.error('Error:', error);
            typingIndicator.remove();
            
            const errorDiv = document.createElement('div');
            errorDiv.className = 'message agent-message';
            errorDiv.innerHTML = '‚ùå Sorry, something went wrong. Please try again.';
            chatMessages.appendChild(errorDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        });
    }

    function createTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.className = 'typing-indicator';
        typingDiv.innerHTML = `
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <div class="typing-dot"></div>
            <span style="margin-left: 10px; color: var(--text-secondary); font-size: 0.9em;">AI is thinking...</span>
        `;
        return typingDiv;
    }

    function formatAIResponse(response) {
        // First, let's clean up the response text
        let formatted = response;
        
        // Convert markdown-like formatting to proper markdown
        formatted = formatted
            // Convert **text** to proper markdown
            .replace(/\*\*(.*?)\*\*/g, '**$1**')
            // Convert * text to proper list items
            .replace(/^\s*\*\s+/gm, '- ')
            // Convert emojis and text patterns to better formatting
            .replace(/üìö\s*\*\*(.*?)\*\*:/g, '## üìö $1')
            .replace(/üìù\s*\*\*(.*?)\*\*:/g, '## üìù $1')
            .replace(/üìã\s*\*\*(.*?)\*\*:/g, '## üìã $1')
            .replace(/‚úÖ\s*\*\*(.*?)\*\*:/g, '## ‚úÖ $1')
            .replace(/üìÖ\s*\*\*(.*?)\*\*:/g, '## üìÖ $1')
            // Convert priority and status indicators
            .replace(/\(üü¢\s+(.*?)\)/g, '<span class="priority-badge priority-low">$1</span>')
            .replace(/\(üü°\s+(.*?)\)/g, '<span class="priority-badge priority-medium">$1</span>')
            .replace(/\(üü†\s+(.*?)\)/g, '<span class="priority-badge priority-high">$1</span>')
            .replace(/\(üî¥\s+(.*?)\)/g, '<span class="priority-badge priority-urgent">$1</span>')
            // Convert status indicators
            .replace(/‚úÖ\s+Completed/g, '<span class="status-completed">‚úÖ Completed</span>')
            .replace(/‚è∞\s+Pending/g, '<span class="status-pending">‚è∞ Pending</span>')
            .replace(/‚úÖ\s+Present/g, '<span class="status-present">‚úÖ Present</span>')
            .replace(/‚ùå\s+Absent/g, '<span class="status-absent">‚ùå Absent</span>');

        // Parse markdown to HTML
        let html = marked.parse(formatted);
        
        // Add custom styling to course and assignment items
        html = html
            .replace(/<li><strong>(.*?)<\/strong>\s*\(([^)]+)\)<br>/g, 
                '<li class="course-item"><strong>$1</strong> ($2)<br>')
            .replace(/<li><strong>(.*?)<\/strong>\s*\([^)]+\)<br>/g, 
                '<li class="assignment-item"><strong>$1</strong><br>')
            .replace(/<li><strong>(.*?)<\/strong>\s*\([^)]+\)<br>/g, 
                '<li class="exam-item"><strong>$1</strong><br>');

        // Add some custom CSS for priority badges
        html += `
            <style>
                .priority-badge {
                    display: inline-block;
                    padding: 2px 8px;
                    border-radius: 12px;
                    font-size: 0.8em;
                    font-weight: 600;
                    color: white;
                    margin-left: 5px;
                }
                .status-completed, .status-present {
                    color: var(--success-color);
                    font-weight: 600;
                }
                .status-pending {
                    color: var(--warning-color);
                    font-weight: 600;
                }
                .status-absent {
                    color: var(--danger-color);
                    font-weight: 600;
                }
            </style>
        `;

        return html;
    }
    
    // Helper function to get the CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.startsWith(name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Auto-focus on input when page loads
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('user-input').focus();
    });
</script>
{% endblock %}